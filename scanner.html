<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leitor ESIP — Simples e Estável</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body{margin:0;font-family:Arial;background:#e7f0ff;color:#003f88}
    header{background:#0077ff;color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px}
    header img{width:48px;height:48px;border-radius:6px;background:#fff;padding:4px}
    header h1{margin:0;font-size:22px}

    .box{background:#fff;padding:18px;margin:20px auto;border-radius:12px;max-width:420px;box-shadow:0 2px 8px #0002}
    button{padding:10px 18px;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    .ok{background:#0fbd7f;color:#fff}
    .err{background:#ff4e4e;color:#fff}
    .msg{padding:14px;margin-top:14px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;font-weight:bold}
    .valid{background:#d8ffee;color:#0a6b45}
    .invalid{background:#ffe3e3;color:#a30000}
    #logBox{margin-top:20px;font-size:14px;max-height:160px;overflow:auto;background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px #0001}
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="ESIP">
  <h1>Leitor ESIP</h1>
</header>

<div class="box" id="loginBox">
  <h2>Login</h2>
  <p>Digite a senha:</p>
  <input id="senha" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #bbb;font-size:16px">
  <button class="ok" style="margin-top:14px;width:100%" onclick="login()">Entrar</button>
</div>

<div class="box" id="scanBox" style="display:none">
  <h2>Scanner</h2>
  <div id="reader" style="width:100%"></div>

  <div id="msgArea"></div>

  <h3>Log de entradas</h3>
  <div id="logBox"></div>

  <button class="ok" style="margin-top:10px;width:100%" onclick="exportCSV()">Exportar CSV</button>
</div>

<script>
let lastScan = "";
let cooldown = false;
let log = [];

function login(){
  if(document.getElementById("senha").value === "ESIP2025"){
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("scanBox").style.display = "block";
    startScanner();
  }
}

function startScanner(){
  const qr = new Html5Qrcode("reader");

  qr.start({ facingMode:"environment" }, {fps:10, qrbox:250}, (text)=>{
      if(cooldown) return;
      cooldown = true;
      setTimeout(()=>cooldown=false, 2500);

      processQR(text);
  });
}

function processQR(code){
  let valid = code.startsWith("ESIP");

  showMessage(valid ? "Ingresso válido" : "Ingresso inválido", valid);

  // log
  log.push({codigo:code, status:valid?"válido":"inválido", hora:new Date().toLocaleString()});
  updateLogBox();
}

function showMessage(text, ok){
  const area = document.getElementById("msgArea");
  area.innerHTML = `
    <div class="msg ${ok?"valid":"invalid"}">
      <span>${text}</span>
      <button style="background:none;border:none;font-size:20px;color:inherit;cursor:pointer" onclick="this.parentElement.remove()">×</button>
    </div>`;
}

function updateLogBox(){
  let html = "";
  log.slice().reverse().forEach(l=>{
    html += `<div><b>${l.status}</b> — ${l.codigo}<br><small>${l.hora}</small></div><hr>`;
  });
  document.getElementById("logBox").innerHTML = html;
}

function exportCSV(){
  let csv = "codigo,status,hora\n";
  log.forEach(l=>{
    csv += `${l.codigo},${l.status},${l.hora}\n`;
  });

  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "entradas_esip.csv";
  a.click();
}
</script>

</body>
</html>

